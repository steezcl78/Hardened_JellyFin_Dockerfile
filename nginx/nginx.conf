# Nginx Reverse Proxy Configuration for Jellyfin
# Security-focused configuration with SSL termination
#
# What this file does:
# - Listens on port 443 (HTTPS) and terminates SSL
# - Forwards decrypted traffic to Jellyfin on the internal Docker network
# - Adds security headers to protect against common web attacks
# - Hides Jellyfin's identity from external attackers

# Run as non-root user for security (nginx user is built into the image)
user nginx;

# Auto-detect CPU cores - worker_processes handles concurrent connections
# "auto" means Nginx will spawn one worker per CPU core
worker_processes auto;

# Where to write error logs and at what verbosity level
error_log /var/log/nginx/error.log warn;

# Process ID file - used by the system to track the Nginx master process
pid /var/run/nginx.pid;

# Connection handling settings
events {
    # Maximum simultaneous connections per worker
    # 1024 is plenty for a home media server
    worker_connections 1024;
}

http {
    # ═══════════════════════════════════════════════════════════════════
    # BASIC SETTINGS
    # ═══════════════════════════════════════════════════════════════════

    # Include mime type definitions (tells browsers what type of file they're receiving)
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Log format - standard combined format with timing info
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # Performance optimizations
    sendfile on;           # Efficient file transfer (kernel-level)
    tcp_nopush on;         # Send headers and file data together
    tcp_nodelay on;        # Don't buffer small packets
    keepalive_timeout 65;  # How long to keep connections open

    # ═══════════════════════════════════════════════════════════════════
    # SECURITY SETTINGS
    # ═══════════════════════════════════════════════════════════════════

    # Hide Nginx version in error pages and headers
    # Why: Attackers use version info to find known vulnerabilities
    server_tokens off;

    # Prevent clickjacking attacks
    # Why: Stops malicious sites from embedding your Jellyfin in an iframe
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME-type sniffing
    # Why: Stops browsers from guessing content types (can lead to XSS)
    add_header X-Content-Type-Options "nosniff" always;

    # Enable XSS filter in older browsers
    # Why: Extra layer of protection against cross-site scripting
    add_header X-XSS-Protection "1; mode=block" always;

    # Control what information is sent in the Referer header
    # Why: Prevents leaking internal URLs to external sites
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ═══════════════════════════════════════════════════════════════════
    # SSL/TLS CONFIGURATION
    # ═══════════════════════════════════════════════════════════════════

    # Only use TLS 1.2 and 1.3 (older versions have known vulnerabilities)
    # TLS 1.0 and 1.1 are deprecated and insecure
    ssl_protocols TLSv1.2 TLSv1.3;

    # Prefer server's cipher order over client's
    # Why: Ensures we use the strongest cipher the client supports
    ssl_prefer_server_ciphers on;

    # Modern cipher suite - these are the encryption algorithms used
    # Why: Excludes weak ciphers that could be cracked
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;

    # SSL session caching - improves performance for returning visitors
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ═══════════════════════════════════════════════════════════════════
    # UPSTREAM DEFINITION
    # ═══════════════════════════════════════════════════════════════════

    # Define the backend server (Jellyfin)
    # "jellyfin" is the Docker service name - Docker's internal DNS resolves this
    # to the container's IP address on the internal network
    upstream jellyfin_backend {
        server jellyfin:8096;

        # Keep connections open to backend for better performance
        keepalive 32;
    }

    # ═══════════════════════════════════════════════════════════════════
    # HTTP SERVER (Redirect to HTTPS)
    # ═══════════════════════════════════════════════════════════════════

    server {
        listen 80;
        server_name _;

        # Redirect ALL HTTP traffic to HTTPS
        # 301 = permanent redirect (browsers will remember this)
        # Why: Ensures users always use the encrypted connection
        return 301 https://$host$request_uri;
    }

    # ═══════════════════════════════════════════════════════════════════
    # HTTPS SERVER (Main Configuration)
    # ═══════════════════════════════════════════════════════════════════

    server {
        listen 443 ssl http2;
        server_name _;

        # SSL certificate paths (mounted from host)
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        # Enable HSTS (HTTP Strict Transport Security)
        # Why: Tells browsers to ONLY use HTTPS for this site for 1 year
        # Warning: Only enable this if you're committed to always having HTTPS
        # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # ═══════════════════════════════════════════════════════════════
        # JELLYFIN PROXY
        # ═══════════════════════════════════════════════════════════════

        location / {
            # Forward requests to Jellyfin
            proxy_pass http://jellyfin_backend;

            # Use HTTP/1.1 for backend connection (required for keepalive)
            proxy_http_version 1.1;

            # Headers to pass to Jellyfin
            # These tell Jellyfin about the original request
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;

            # WebSocket support (required for Jellyfin's real-time features)
            # WebSockets keep a persistent connection for live updates
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Timeout settings (streaming can take a long time)
            proxy_connect_timeout 60s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;

            # Buffering settings
            # For streaming, we want minimal buffering
            proxy_buffering off;

            # Don't limit response size (media files are large)
            proxy_max_temp_file_size 0;
        }

        # Socket.io path for Jellyfin (real-time sync)
        location /socket {
            proxy_pass http://jellyfin_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
